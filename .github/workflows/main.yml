on:
  push:
    branches:
      - main

name: ğŸš€ Despliegue Laravel a ProducciÃ³n

jobs:
  web-deploy:
    name: ğŸ‰ Despliegue
    runs-on: ubuntu-latest

    steps:
    # 1. Clonar el cÃ³digo
    - name: ğŸšš Obtener cÃ³digo mÃ¡s reciente
      uses: actions/checkout@v4

    # 2. Configurar PHP y Composer
    - name: âš™ï¸ Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        extensions: mbstring, intl, bcmath, gd, pdo, pdo_mysql
        ini-values: post_max_size=256M, upload_max_filesize=256M, max_execution_time=300
        coverage: none

    # 3. Instalar dependencias de Laravel
    - name: ğŸ“¦ Instalar dependencias con Composer
      run: composer install --no-dev --optimize-autoloader

    # 4. Copiar archivo .env
    - name: ğŸ“„ Copiar archivo .env
      run: cp .env.production .env

    # 5. Generar la clave de la aplicaciÃ³n
    - name: ğŸ”‘ Generar clave de la aplicaciÃ³n
      run: php artisan key:generate

    # 6. Ejecutar migraciones
    - name: ğŸ—‚ï¸ Ejecutar migraciones
      run: php artisan migrate --force

    # 7. Optimizar cachÃ©
    - name: âš¡ Optimizar cachÃ© de Laravel
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    # 8. Sincronizar archivos al servidor vÃ­a FTP
    - name: ğŸ“‚ Subir archivos al servidor FTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: dev.imaarica.cl
        username: ${{ secrets.ftp_username }}
        password: ${{ secrets.ftp_password }}
        local-dir: ./ 
        server-dir: ./ 
        exclude: |
          **/.git*
          **/node_modules/**
          **/vendor/**
          **/.env*
          **/storage/**
          **/tests/**
          **/docker-compose.yml
          **/package-lock.json
