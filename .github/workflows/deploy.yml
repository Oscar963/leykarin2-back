on:
  push:
    branches:
      - main

name: ğŸš€ Despliegue Laravel API a ProducciÃ³n

jobs:
  web-deploy:
    name: ğŸ‰ Despliegue API
    runs-on: ubuntu-latest

    steps:
      # 1. Clonar el cÃ³digo
      - name: ğŸšš Obtener cÃ³digo mÃ¡s reciente
        uses: actions/checkout@v4

      # 2. Configurar PHP y Composer
      - name: âš™ï¸ Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4
          extensions: mbstring, intl, bcmath, pdo, pdo_mysql
          ini-values: post_max_size=256M, upload_max_filesize=256M, max_execution_time=300
          coverage: none

      # 3. Instalar dependencias de Laravel
      - name: ğŸ“¦ Instalar dependencias con Composer
        run: composer install --no-dev --optimize-autoloader

      # 7. Optimizar configuraciÃ³n (sin cache de vistas o rutas innecesarias)
      - name: âš¡ Optimizar configuraciÃ³n
        run: php artisan config:cache

      # 8. Subir archivos al servidor vÃ­a FTP (ignorando .env y directorios innecesarios)
      - name: ğŸ“‚ Subir archivos al servidor FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: dev.imaarica.cl
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          local-dir: ./
          server-dir: ./intranet/
          exclude: |
            **/.git*
            **/node_modules/**
            **/.env*
            **/storage/**
            **/tests/**
            **/docker-compose.yml
            **/package-lock.json

      # 6. Subir la carpeta 'public' a 'public_html/intranet'
      - name: ğŸ“‚ Subir carpeta 'public' a 'public_html/intranet'
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: dev.imaarica.cl
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          local-dir: ./public/
          server-dir: ./public_html/intranet/
          exclude: |
            **/.git*
            **/node_modules/**
            **/.env*
            **/tests/**

    # 9. ğŸ“¢ Nota Importante sobre el Servidor
    # ---------------------------------------------------------------
    # âš ï¸ DespuÃ©s del despliegue, asegÃºrate de:
    #
    # âœ… Tener un archivo `.env` correctamente configurado en el servidor.
    # âœ… Ejecutar manualmente en el servidor:
    #      - composer install --no-dev --optimize-autoloader
    #      - php artisan migrate --force (si no se migrÃ³ correctamente)
    #      - php artisan config:cache
    # âœ… Configurar permisos correctos en las carpetas:
    #      - storage/
    #      - bootstrap/cache
    # âœ… Reiniciar el servicio PHP-FPM o el servidor web si es necesario.
    # ---------------------------------------------------------------
